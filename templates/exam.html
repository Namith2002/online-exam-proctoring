{% extends "base.html" %}
{% block content %}
<div class="mb-4">
  <h1>{{ exam.title }}</h1>
  <p>Complete all questions within the time limit. Your progress is automatically saved.</p>
</div>

<!-- Timer -->
<div class="timer" id="timerContainer">
  <div class="timer-label">Time Remaining</div>
  <div class="timer-value" id="timer">--:--</div>
</div>
<div id="examDuration" data-minutes="{{ exam.duration_minutes }}" style="display:none;"></div>

<!-- Consent modal -->
<div id="consentModal" class="consent-modal">
  <div class="consent-box">
    <h3>üîí Proctoring Consent Required</h3>
    <p>To maintain exam integrity, we need to:</p>
    <ul style="margin: 1rem 0; padding-left: 1.5rem;">
      <li>Access your camera</li>
      <li>Take periodic snapshots (every 15 seconds)</li>
    </ul>
    <p><strong>Privacy Notice:</strong> All recordings are encrypted and only accessible to exam administrators for integrity verification.</p>
    <div class="consent-actions">
      <button id="consentReject" class="btn secondary">Decline & Exit</button>
      <button id="consentAccept" class="btn primary">Accept & Continue</button>
    </div>
  </div>
</div>

<!-- Proctoring area -->
<div id="proctor-area">
  <video id="video" autoplay playsinline width="320" height="240"></video>
  <div class="proctor-info">
    <p id="proctorStatus" class="proctor-status waiting">üîÑ Waiting for consent...</p>
    <p class="small">
      üì∏ Snapshots every 15s<br>
      Keep your face visible and avoid suspicious behavior
    </p>
  </div>
</div>

<!-- Exam form -->
<form id="examForm" method="post" action="{{ url_for('submit_exam') }}">
  <input type="hidden" name="attempt_id" value="{{ attempt_id }}">
  
  <!-- Question Navigation -->
  <div class="question-nav" id="questionNav">
    <!-- Will be populated by JavaScript -->
  </div>
  
  <div id="questions">
    {% for q in questions %}
      <div class="question" data-qid="{{ q.id }}" id="question{{ loop.index }}" style="display: {% if loop.index == 1 %}block{% else %}none{% endif %};">
        <div class="question-header">
          Question {{ loop.index }} of {{ questions|length }}
        </div>
        <p style="margin-bottom: 1.5rem; font-size: 1.1rem; line-height: 1.6;">{{ q.question }}</p>
        <div class="question-options">
          <label class="option" for="q{{ q.id }}_a">
            <input type="radio" id="q{{ q.id }}_a" name="q{{ q.id }}" value="A">
            <span>A) {{ q.option_a }}</span>
          </label>
          <label class="option" for="q{{ q.id }}_b">
            <input type="radio" id="q{{ q.id }}_b" name="q{{ q.id }}" value="B">
            <span>B) {{ q.option_b }}</span>
          </label>
          <label class="option" for="q{{ q.id }}_c">
            <input type="radio" id="q{{ q.id }}_c" name="q{{ q.id }}" value="C">
            <span>C) {{ q.option_c }}</span>
          </label>
          <label class="option" for="q{{ q.id }}_d">
            <input type="radio" id="q{{ q.id }}_d" name="q{{ q.id }}" value="D">
            <span>D) {{ q.option_d }}</span>
          </label>
        </div>
        <div class="question-navigation">
          {% if not loop.first %}
            <button type="button" class="btn secondary prev-question" data-question="{{ loop.index }}">‚Üê Previous</button>
          {% endif %}
          {% if not loop.last %}
            <button type="button" class="btn primary next-question" data-question="{{ loop.index }}">Next ‚Üí</button>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="exam-footer">
    <div class="auto-save-status">
      <button class="btn secondary" type="button" id="saveAnswers" data-tooltip="Your answers are automatically saved">
        üíæ Auto-Save Active
      </button>
    </div>
    <div class="submit-section">
      <button class="btn primary lg submit-exam" type="button" id="submitExam">
        ‚úÖ Submit Exam
      </button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="submitModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Confirm Exam Submission</h3>
      <p>Are you sure you want to submit your exam? This action cannot be undone.</p>
      <div class="modal-actions">
        <button type="button" class="btn secondary" id="cancelSubmit">Cancel</button>
        <button type="submit" class="btn primary" id="confirmSubmit">Yes, Submit Exam</button>
      </div>
    </div>
  </div>
</form>

<script>
  // Enhanced exam interaction
  document.addEventListener('DOMContentLoaded', function() {
    let currentQuestion = 1;
    const totalQuestions = document.querySelectorAll('.question').length;

    // Handle option selection styling
    const options = document.querySelectorAll('.option');
    options.forEach(option => {
      const radio = option.querySelector('input[type="radio"]');
      radio.addEventListener('change', function() {
        // Remove selected class from all options in this question
        const questionOptions = option.closest('.question').querySelectorAll('.option');
        questionOptions.forEach(opt => opt.classList.remove('selected'));
        
        // Add selected class to current option
        if (this.checked) {
          option.classList.add('selected');
          // Auto save when an option is selected
          saveAnswer(this.name, this.value);
        }
      });
    });

    // Navigation functions
    function showQuestion(number) {
      document.querySelectorAll('.question').forEach(q => q.style.display = 'none');
      document.getElementById(`question${number}`).style.display = 'block';
      currentQuestion = number;
      updateQuestionNav();
    }

    function updateQuestionNav() {
      // Update question navigation status
      document.querySelectorAll('.question-nav-item').forEach((item, index) => {
        item.classList.toggle('current', index + 1 === currentQuestion);
      });
    }

    // Next/Previous button handlers
    document.querySelectorAll('.next-question').forEach(btn => {
      btn.addEventListener('click', function() {
        const nextQuestion = parseInt(this.dataset.question) + 1;
        if (nextQuestion <= totalQuestions) {
          showQuestion(nextQuestion);
        }
      });
    });

    document.querySelectorAll('.prev-question').forEach(btn => {
      btn.addEventListener('click', function() {
        const prevQuestion = parseInt(this.dataset.question) - 1;
        if (prevQuestion >= 1) {
          showQuestion(prevQuestion);
        }
      });
    });

    // Question navigation
    const questionNav = document.getElementById('questionNav');
    for (let i = 1; i <= totalQuestions; i++) {
      const navItem = document.createElement('button');
      navItem.className = 'question-nav-item' + (i === 1 ? ' current' : '');
      navItem.textContent = i;
      navItem.addEventListener('click', () => showQuestion(i));
      questionNav.appendChild(navItem);
    }

    // Auto-save functionality
    function saveAnswer(questionId, answer) {
      const saveBtn = document.getElementById('saveAnswers');
      fetch(SAVE_ANSWER_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          attempt_id: ATTEMPT_ID,
          question_id: questionId,
          answer: answer
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          saveBtn.innerHTML = '‚úÖ Saved';
          setTimeout(() => {
            saveBtn.innerHTML = 'üíæ Auto-Save Active';
          }, 2000);
        }
      })
      .catch(error => {
        console.error('Error saving answer:', error);
        saveBtn.innerHTML = '‚ö†Ô∏è Save Failed';
      });
    }

    // Submit exam handling
    const submitModal = document.getElementById('submitModal');
    const submitBtn = document.getElementById('submitExam');
    const confirmSubmit = document.getElementById('confirmSubmit');
    const cancelSubmit = document.getElementById('cancelSubmit');

    submitBtn.addEventListener('click', function() {
      submitModal.style.display = 'block';
    });

    cancelSubmit.addEventListener('click', function() {
      submitModal.style.display = 'none';
    });

    // Close modal if clicking outside
    window.addEventListener('click', function(event) {
      if (event.target === submitModal) {
        submitModal.style.display = 'none';
      }
    });
  });
</script>

<script>
  // pass server allowed_until safely to JS using tojson (will be a quoted string)
  const ATTEMPT_ID = "{{ attempt_id }}";
  const IMG_UPLOAD = "{{ url_for('proctor_upload_image') }}";
  
  const SAVE_ANSWER_URL = "{{ url_for('save_answer') }}";
  const LOG_EVENT_URL = "{{ url_for('proctor_log_event') }}";
  const SERVER_ALLOWED_UNTIL = {{ allowed_until | tojson }}; // ISO UTC time string from server
</script>
<script src="{{ url_for('static', filename='js/proctor.js') }}"></script>
{% endblock %}
